FROM golang:1.16-alpine as builder

ENV APP_HOME /go/src/app

WORKDIR /app

RUN set -ex; \
    apk update; \
    apk add --no-cache \
    git \
    gcc \
    musl-dev \
    make

COPY go.mod ./
COPY go.sum ./

#Set Env
ARG ACCESS_TOKEN

ENV ACCESS_TOKEN=$ACCESS_TOKEN

#Set github login
RUN go env -w GOPRIVATE=github.com/oasis-prime/oas-platform-core \
    git config --global url."https://${ACCESS_TOKEN}:x-oauth-basic@github.com".insteadOf "https://github.com"

RUN go mod download

COPY ./ .

RUN CGO_ENABLED=0 GOOS=linux go build -o goapp ./cmd/api/main.go

##########################################

FROM alpine:3.13.1 as release

WORKDIR /app

#Set Env
ARG ACCESS_TOKEN \
    GIN_MODE \
    APP_ENV \
    APP_PORT \
    ACCESS_TOKEN \
    DATABASE_NAME \
    DATABASE_USER \
    DATABASE_PWD \
    DATABASE_INSTANCE_CONNECTION_NAME \
    DATABASE_SOCKET_DIR \
    JWT_SECRET \
    JWT_EXPIRATIONDELTA \
    REDIS_ADDR \
    REDIS_PASSWORD \
    REDIS_DB \
    HOTELBEDS_ENDPOINT \
    HOTELBEDS_SECUREENDOPINT \
    HOTELBEDS_KEY \
    HOTELBEDS_SECRET \
    HOTELBEDS_FORMAT

ENV ACCESS_TOKEN=$ACCESS_TOKEN \
    GIN_MODE=$GIN_MODE \
    APP_ENV=$APP_ENV \
    APP_PORT=$APP_PORT \
    ACCESS_TOKEN=$ACCESS_TOKEN \
    DATABASE_NAME=$DATABASE_NAME \
    DATABASE_USER=$DATABASE_USER \
    DATABASE_PWD=$DATABASE_PWD \
    DATABASE_INSTANCE_CONNECTION_NAME=$DATABASE_INSTANCE_CONNECTION_NAME \
    DATABASE_SOCKET_DIR=$DATABASE_SOCKET_DIR \
    JWT_SECRET=$JWT_SECRET \
    JWT_EXPIRATIONDELTA=$JWT_EXPIRATIONDELTA \
    REDIS_ADDR=$REDIS_ADDR \
    REDIS_PASSWORD=$REDIS_PASSWORD \
    REDIS_DB=$REDIS_DB \
    HOTELBEDS_ENDPOINT=$HOTELBEDS_ENDPOINT \
    HOTELBEDS_SECUREENDOPINT=$HOTELBEDS_SECUREENDOPINT \
    HOTELBEDS_KEY=$HOTELBEDS_KEY \
    HOTELBEDS_SECRET=$HOTELBEDS_SECRET \
    HOTELBEDS_FORMAT=$HOTELBEDS_FORMAT

COPY --from=builder ./app/goapp ./goapp

EXPOSE 8080

CMD ["./goapp"]